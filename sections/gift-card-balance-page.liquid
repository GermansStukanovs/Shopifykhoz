<div class="gift-card-balance-page page-width page-width--narrow">
  {% if section.settings.heading != blank %}
    <h2 class="gift-card-balance-page__heading">{{ section.settings.heading | escape }}</h2>
  {% endif %}

  {% if section.settings.description != blank %}
    <div class="gift-card-balance-page__description rte">
      {{ section.settings.description }}
    </div>
  {% endif %}

  <div class="gift-card-balance-page__form-container">
    <div class="gift-card-balance-checker__form">
      <div class="gift-card-balance-checker__input-wrap">
        <label for="gift-card-code" class="visually-hidden">
          {{ section.settings.input_label | escape }}
        </label>
        <input
          type="text"
          id="gift-card-code"
          class="gift-card-balance-checker__input"
          placeholder="{{ section.settings.input_placeholder | escape }}"
          aria-label="{{ section.settings.input_label | escape }}"
        >
      </div>

      <button
        type="button"
        class="gift-card-balance-checker__button"
        id="check-balance-button"
        style="background-color: #000000; color: white;"
      >
        <span id="button-text">{{ section.settings.button_text | escape }}</span>
        <span
          id="button-loading"
          class="gift-card-balance-checker__spinner"
          style="display: none;"
        ></span>
      </button>
    </div>

    <div
      id="gift-card-result"
      class="gift-card-balance-checker__result"
      style="display: none;"
    >
      <div class="gift-card-balance-checker__card">
        <div class="gift-card-balance-checker__card-header">
          <h3 class="gift-card-balance-checker__card-title">Gift Card Balance</h3>
        </div>
        <div class="gift-card-balance-checker__card-content">
          <div class="gift-card-balance-checker__card-info">
            <div class="gift-card-balance-checker__card-row">
              <span class="gift-card-balance-checker__card-label">Card Number:</span>
              <span class="gift-card-balance-checker__card-number"></span>
            </div>
            <div class="gift-card-balance-checker__card-row">
              <span class="gift-card-balance-checker__card-label">Balance:</span>
              <span class="gift-card-balance-checker__card-balance"></span>
            </div>
            <div class="gift-card-balance-checker__card-row">
              <span class="gift-card-balance-checker__card-label">Status:</span>
              <span class="gift-card-balance-checker__card-status"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="gift-card-error"
      class="gift-card-balance-checker__error"
      style="display: none;"
    >
      <p class="gift-card-balance-checker__error-message"></p>
    </div>

    <div class="gift-card-balance-page__info">
      {% if section.settings.info_heading != blank %}
        <h3>{{ section.settings.info_heading | escape }}</h3>
      {% endif %}

      {% if section.settings.info_text != blank %}
        <div class="rte">
          {{ section.settings.info_text }}
        </div>
      {% endif %}

      <div class="gift-card-balance-page__contact">
        {% if section.settings.contact_heading != blank %}
          <h3>{{ section.settings.contact_heading | escape }}</h3>
        {% endif %}

        {% if section.settings.contact_text != blank %}
          <div class="rte">
            {{ section.settings.contact_text }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
  .gift-card-balance-page {
    margin-top: 2rem;
  }

  .gift-card-balance-page__heading {
    margin-bottom: 1rem;
    text-align: center;
  }

  .gift-card-balance-page__description {
    margin-bottom: 2rem;
    text-align: center;
  }

  .gift-card-balance-page__form-container {
    max-width: 600px;
    margin: 0 auto;
  }

  .gift-card-balance-checker__form {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .gift-card-balance-checker__input-wrap {
    flex: 1;
    min-width: 200px;
  }

  .gift-card-balance-checker__input {
    width: 100%;
    padding: 1rem;
    border: 1px solid rgba(var(--color-foreground), 0.15);
    border-radius: 4px;
    font-size: 1.6rem;
  }

  .gift-card-balance-checker__button {
    padding: 1rem 2rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 15rem;
  }

  .gift-card-balance-checker__spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .gift-card-balance-checker__result {
    margin: 2rem 0;
  }

  .gift-card-balance-checker__card {
    border: 1px solid rgba(var(--color-foreground), 0.08);
    border-radius: 8px;
    overflow: hidden;
  }

  .gift-card-balance-checker__card-header {
    background-color: rgba(var(--color-foreground), 0.05);
    padding: 1.5rem;
    border-bottom: 1px solid rgba(var(--color-foreground), 0.08);
  }

  .gift-card-balance-checker__card-title {
    margin: 0;
    font-size: 1.8rem;
  }

  .gift-card-balance-checker__card-content {
    padding: 1.5rem;
  }

  .gift-card-balance-checker__card-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(var(--color-foreground), 0.08);
  }

  .gift-card-balance-checker__card-row:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .gift-card-balance-checker__card-label {
    font-weight: bold;
    color: rgba(var(--color-foreground), 0.75);
  }

  .gift-card-balance-checker__card-balance {
    font-weight: bold;
  }

  .gift-card-balance-checker__error {
    background-color: rgba(var(--color-error), 0.1);
    color: rgb(var(--color-error));
    padding: 1.5rem;
    border-radius: 4px;
    margin: 2rem 0;
    display: flex;
    align-items: center;
  }

  .gift-card-balance-checker__error-message {
    margin: 0;
  }

  .gift-card-balance-page__info {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(var(--color-foreground), 0.08);
  }

  .gift-card-balance-page__contact {
    margin-top: 2rem;
    padding: 1.5rem;
    background-color: rgba(var(--color-foreground), 0.04);
    border-radius: 4px;
  }

  @media screen and (max-width: 749px) {
    .gift-card-balance-checker__form {
      flex-direction: column;
    }

    .gift-card-balance-checker__button {
      width: 100%;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const checkBalanceButton = document.getElementById('check-balance-button');
    const buttonText = document.getElementById('button-text');
    const buttonLoading = document.getElementById('button-loading');
    const giftCardInput = document.getElementById('gift-card-code');
    const resultDiv = document.getElementById('gift-card-result');
    const errorDiv = document.getElementById('gift-card-error');
    const cardNumber = resultDiv.querySelector('.gift-card-balance-checker__card-number');
    const cardBalance = resultDiv.querySelector('.gift-card-balance-checker__card-balance');
    const cardStatus = resultDiv.querySelector('.gift-card-balance-checker__card-status');
    const errorMessage = errorDiv.querySelector('.gift-card-balance-checker__error-message');

    // Check if there's a code in the URL and auto-check it
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('code')) {
      giftCardInput.value = urlParams.get('code');
      // Trigger the balance check
      setTimeout(() => {
        checkBalanceButton.click();
      }, 500);
    }

    checkBalanceButton.addEventListener('click', async function () {
      const code = giftCardInput.value.trim();

      if (!code) {
        showError('Please enter a gift card code');
        return;
      }

      try {
        // Show loading state
        setLoadingState(true);

        const response = await fetch('{{ section.settings.api_endpoint }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Shopify-Shop-Domain': '{{ shop.domain }}',
          },
          body: JSON.stringify({ giftCardNumber: code }),
        });

        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);

        if (!response.ok) {
          showError(data.error || 'An error occurred while checking the balance');
          return;
        }

        if (!data.balance || !data.currencyCode) {
          showError('Invalid gift card data received');
          return;
        }

        // Format the card number (mask all but last 4 digits)
        const formattedCardNumber = formatCardNumber(code);

        // Update card details
        cardNumber.textContent = formattedCardNumber;
        cardBalance.textContent = formatCurrency(data.balance, data.currencyCode);

        // Update status with appropriate styling
        const status = data.status || 'active';
        cardStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        cardStatus.className = 'gift-card-balance-checker__card-status ' + status.toLowerCase();

        // Show result
        resultDiv.style.display = 'block';
        errorDiv.style.display = 'none';
      } catch (error) {
        console.error('Error checking balance:', error);
        showError('An error occurred while checking the balance. Please try again later.');
      } finally {
        // Reset loading state
        setLoadingState(false);
      }
    });

    // Handle Enter key press
    giftCardInput.addEventListener('keypress', function (event) {
      if (event.key === 'Enter') {
        checkBalanceButton.click();
      }
    });

    function setLoadingState(isLoading) {
      checkBalanceButton.disabled = isLoading;
      buttonText.style.display = isLoading ? 'none' : 'inline';
      buttonLoading.style.display = isLoading ? 'inline-block' : 'none';
    }

    function showError(message) {
      resultDiv.style.display = 'none';
      errorDiv.style.display = 'flex';
      errorMessage.textContent = message;
    }

    function formatCardNumber(cardNumber) {
      if (!cardNumber) return '';

      // Only show last 4 digits
      const length = cardNumber.length;
      if (length <= 4) return cardNumber;

      const lastFour = cardNumber.slice(-4);
      const maskedPart = '•'.repeat(length - 4);

      // Format with spaces for readability
      return `${maskedPart} ${lastFour}`;
    }

    function formatCurrency(amount, currencyCode) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currencyCode || 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }).format(amount);
    }
  });
</script>

{% schema %}
{
  "name": "Gift Card Balance Page",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "Check Gift Card Balance",
      "label": "Heading"
    },
    {
      "type": "richtext",
      "id": "description",
      "default": "<p>Enter your gift card code below to check your available balance.</p>",
      "label": "Description"
    },
    {
      "type": "text",
      "id": "input_label",
      "default": "Gift Card Code",
      "label": "Input label"
    },
    {
      "type": "text",
      "id": "input_placeholder",
      "default": "Enter gift card code",
      "label": "Input placeholder"
    },
    {
      "type": "text",
      "id": "button_text",
      "default": "Check Balance",
      "label": "Button text"
    },
    {
      "type": "header",
      "content": "Information Section"
    },
    {
      "type": "text",
      "id": "info_heading",
      "default": "How to Check Your Gift Card Balance",
      "label": "Information heading"
    },
    {
      "type": "richtext",
      "id": "info_text",
      "default": "<ol><li>Enter your gift card number in the field above</li><li>Click \"Check Balance\" to see your available balance</li><li>If you have any issues, please contact our customer service team</li></ol>",
      "label": "Information text"
    },
    {
      "type": "header",
      "content": "Contact Section"
    },
    {
      "type": "text",
      "id": "contact_heading",
      "default": "Need Help?",
      "label": "Contact heading"
    },
    {
      "type": "richtext",
      "id": "contact_text",
      "default": "<p>Contact our customer service team:</p><p>Email: support@example.com</p><p>Phone: 1-800-123-4567</p>",
      "label": "Contact text"
    },
    {
      "type": "text",
      "id": "api_endpoint",
      "default": "https://stuger-gift-card.onrender.com/api/public/check-gift-card",
      "label": "API Endpoint"
    }
  ],
  "presets": [
    {
      "name": "Gift Card Balance Page"
    }
  ]
}
{% endschema %}
